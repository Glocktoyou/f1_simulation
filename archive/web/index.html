<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Vehicle Dynamics Simulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a2e 50%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #e10600 0%, #ff3838 100%);
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(225, 6, 0, 0.3);
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 3em;
            font-weight: 800;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2em;
            margin-top: 10px;
            opacity: 0.95;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .track-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .track-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .track-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(225, 6, 0, 0.2), transparent);
            transition: left 0.5s;
        }

        .track-card:hover::before {
            left: 100%;
        }

        .track-card:hover {
            transform: translateY(-5px);
            border-color: #e10600;
            box-shadow: 0 10px 30px rgba(225, 6, 0, 0.3);
        }

        .track-card.selected {
            border-color: #e10600;
            background: rgba(225, 6, 0, 0.1);
            box-shadow: 0 0 30px rgba(225, 6, 0, 0.4);
        }

        .track-name {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 15px;
            color: #e10600;
        }

        .track-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .track-record {
            font-size: 1.6em;
            font-weight: 700;
            color: #ffdd00;
            margin: 15px 0;
            text-align: center;
        }

        /* Parameter Panel */
        .parameter-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .panel-header {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            color: #e10600;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(225, 6, 0, 0.3);
        }

        .parameter-group {
            margin-bottom: 25px;
        }

        .param-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .param-name {
            font-weight: 600;
        }

        .param-value {
            color: #ffdd00;
            font-weight: 700;
        }

        .param-slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .param-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e10600;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(225, 6, 0, 0.5);
            transition: all 0.2s;
        }

        .param-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(225, 6, 0, 0.8);
        }

        .param-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e10600;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(225, 6, 0, 0.5);
        }

        .param-description {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 5px;
            font-style: italic;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .preset-btn {
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .preset-btn:hover {
            background: rgba(225, 6, 0, 0.2);
            border-color: #e10600;
            transform: translateY(-2px);
        }

        .reset-btn {
            width: 100%;
            padding: 12px;
            background: rgba(255, 165, 0, 0.2);
            border: 1px solid rgba(255, 165, 0, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .reset-btn:hover {
            background: rgba(255, 165, 0, 0.3);
            border-color: #ffa500;
        }

        .simulate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #e10600 0%, #ff3838 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.3em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 5px 20px rgba(225, 6, 0, 0.4);
            margin-top: 20px;
        }

        .simulate-btn:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 8px 30px rgba(225, 6, 0, 0.6);
        }

        .simulate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #e10600;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .results.show {
            display: block;
        }

        .result-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
        }

        .validation-header {
            text-align: center;
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 30px;
            color: #e10600;
        }

        .lap-time-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .time-box {
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .time-label {
            font-size: 1em;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .time-value {
            font-size: 3em;
            font-weight: 800;
            color: #ffdd00;
        }

        .difference {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            text-align: center;
        }

        .difference-value {
            font-size: 2em;
            font-weight: 700;
            margin: 10px 0;
        }

        .difference.excellent {
            border: 2px solid #00ff00;
            background: rgba(0, 255, 0, 0.1);
        }

        .difference.good {
            border: 2px solid #ffa500;
            background: rgba(255, 165, 0, 0.1);
        }

        .difference.needs-work {
            border: 2px solid #ff0000;
            background: rgba(255, 0, 0, 0.1);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
        }

        /* Animation Preview Styles */
        .animation-section {
            margin-top: 25px;
        }

        .animation-container {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #e10600;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .animation-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #e10600;
            margin-bottom: 15px;
        }

        .animation-gif {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(225, 6, 0, 0.3);
        }

        .animation-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .animation-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #e10600 0%, #ff3838 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .animation-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(225, 6, 0, 0.5);
        }

        .animation-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .animation-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .telemetry-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .telemetry-stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #e10600;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #ffdd00;
        }

        .parameter-impact {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border-left: 4px solid #ffdd00;
        }

        .impact-label {
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #ffdd00;
        }

        .impact-value {
            font-size: 1.1em;
            font-weight: 700;
        }

        .segment-grid {
            display: grid;
            gap: 15px;
        }

        .segment-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 15px;
            align-items: center;
            transition: all 0.3s ease;
        }

        .segment-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }

        .segment-item.faster {
            border-left-color: #00ff00;
        }

        .segment-item.slower {
            border-left-color: #ff3838;
        }

        .segment-name {
            font-weight: 700;
            font-size: 1.1em;
        }

        .segment-type {
            font-size: 0.85em;
            opacity: 0.7;
            margin-top: 4px;
        }

        .segment-time {
            text-align: center;
        }

        .segment-label {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 4px;
        }

        .segment-value {
            font-size: 1.3em;
            font-weight: 700;
        }

        .segment-diff {
            text-align: center;
            font-size: 1.2em;
            font-weight: 700;
        }

        .segment-diff.faster {
            color: #00ff00;
        }

        .segment-diff.slower {
            color: #ff3838;
        }

        .segment-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .segment-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #e10600, #ff3838);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .sector-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        .sector-box {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .sector-title {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .sector-time {
            font-size: 1.5em;
            font-weight: 700;
            color: #ffdd00;
            margin-bottom: 5px;
        }

        .sector-diff {
            font-size: 1em;
            font-weight: 600;
        }

        .analysis-box {
            margin-top: 20px;
            padding: 20px;
            background: rgba(225, 6, 0, 0.1);
            border-left: 4px solid #e10600;
            border-radius: 8px;
        }

        .analysis-title {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 10px;
            color: #e10600;
        }

        .analysis-text {
            line-height: 1.6;
            opacity: 0.9;
        }

        .footer {
            text-align: center;
            padding: 30px;
            margin-top: 50px;
            opacity: 0.7;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèéÔ∏è F1 VEHICLE DYNAMICS SIMULATOR</h1>
            <p class="subtitle">Real Track Simulation with Adjustable Vehicle Parameters</p>
        </header>

        <div class="main-grid">
            <div class="track-selector" id="trackSelector">
                <div class="track-card" data-track="silverstone">
                    <div class="track-name">üá¨üáß Silverstone Circuit</div>
                    <div class="track-info">
                        <span>Length:</span>
                        <span>5891 m</span>
                    </div>
                    <div class="track-info">
                        <span>Type:</span>
                        <span>High-speed</span>
                    </div>
                    <div class="track-record">87.097s</div>
                    <div class="track-info">
                        <span style="font-size: 0.85em; opacity: 0.8;">Lewis Hamilton (Mercedes) - 2020</span>
                    </div>
                </div>

                <div class="track-card" data-track="monaco">
                    <div class="track-name">üá≤üá® Circuit de Monaco</div>
                    <div class="track-info">
                        <span>Length:</span>
                        <span>3337 m</span>
                    </div>
                    <div class="track-info">
                        <span>Type:</span>
                        <span>Street Circuit</span>
                    </div>
                    <div class="track-record">70.166s</div>
                    <div class="track-info">
                        <span style="font-size: 0.85em; opacity: 0.8;">Lewis Hamilton (Mercedes) - 2019</span>
                    </div>
                </div>

                <div class="track-card" data-track="spa">
                    <div class="track-name">üáßüá™ Spa-Francorchamps</div>
                    <div class="track-info">
                        <span>Length:</span>
                        <span>7004 m</span>
                    </div>
                    <div class="track-info">
                        <span>Type:</span>
                        <span>Mixed Speed</span>
                    </div>
                    <div class="track-record">106.286s</div>
                    <div class="track-info">
                        <span style="font-size: 0.85em; opacity: 0.8;">Valtteri Bottas (Mercedes) - 2018</span>
                    </div>
                </div>
            </div>

            <div class="parameter-panel">
                <div class="panel-header">‚öôÔ∏è VEHICLE SETUP</div>
                
                <div class="parameter-group">
                    <div class="param-label">
                        <span class="param-name">üèéÔ∏è Engine Power</span>
                        <span class="param-value" id="powerValue">1000 HP</span>
                    </div>
                    <input type="range" class="param-slider" id="powerSlider" 
                           min="700" max="1100" value="1000" step="10">
                    <div class="param-description">Affects top speed and acceleration</div>
                </div>

                <div class="parameter-group">
                    <div class="param-label">
                        <span class="param-name">üîΩ Downforce Level</span>
                        <span class="param-value" id="downforceValue">100%</span>
                    </div>
                    <input type="range" class="param-slider" id="downforceSlider" 
                           min="50" max="150" value="100" step="5">
                    <div class="param-description">Higher = better cornering, lower top speed</div>
                </div>

                <div class="parameter-group">
                    <div class="param-label">
                        <span class="param-name">üõû Tire Grip</span>
                        <span class="param-value" id="tireValue">100%</span>
                    </div>
                    <input type="range" class="param-slider" id="tireSlider" 
                           min="70" max="130" value="100" step="5">
                    <div class="param-description">Affects braking and cornering performance</div>
                </div>

                <div class="parameter-group">
                    <div class="param-label">
                        <span class="param-name">‚öñÔ∏è Vehicle Mass</span>
                        <span class="param-value" id="massValue">798 kg</span>
                    </div>
                    <input type="range" class="param-slider" id="massSlider" 
                           min="750" max="850" value="798" step="5">
                    <div class="param-description">Lighter = faster, but less stable</div>
                </div>

                <div class="parameter-group">
                    <div class="param-label">
                        <span class="param-name">üí® Drag Coefficient</span>
                        <span class="param-value" id="dragValue">100%</span>
                    </div>
                    <input type="range" class="param-slider" id="dragSlider" 
                           min="70" max="130" value="100" step="5">
                    <div class="param-description">Lower = higher top speed</div>
                </div>

                <div class="preset-buttons">
                    <button class="preset-btn" onclick="loadPreset('speed')">
                        ‚ö° Max Speed
                    </button>
                    <button class="preset-btn" onclick="loadPreset('downforce')">
                        üèÅ Max Grip
                    </button>
                    <button class="preset-btn" onclick="loadPreset('balanced')">
                        ‚öñÔ∏è Balanced
                    </button>
                    <button class="preset-btn" onclick="loadPreset('monaco')">
                        üá≤üá® Monaco Setup
                    </button>
                </div>

                <button class="reset-btn" onclick="resetParameters()">
                    üîÑ Reset to Default
                </button>
            </div>
        </div>

        <button class="simulate-btn" id="simulateBtn" disabled>
            üèÅ SELECT A TRACK TO BEGIN SIMULATION
        </button>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Running physics simulation...</p>
            <p style="font-size: 0.9em; opacity: 0.7; margin-top: 10px;">
                Computing aerodynamics, tire dynamics, and lap optimization
            </p>
        </div>

        <div id="results" class="results">
            <div class="result-card">
                <h2 class="validation-header" id="resultTrackName">SIMULATION RESULTS</h2>
                
                <div class="lap-time-comparison">
                    <div class="time-box">
                        <div class="time-label">Real F1 Record</div>
                        <div class="time-value" id="realTime">--</div>
                        <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.7;" id="recordHolder">--</div>
                    </div>
                    <div class="time-box">
                        <div class="time-label">Simulated Time</div>
                        <div class="time-value" id="simTime">--</div>
                        <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.7;">Your Setup</div>
                    </div>
                </div>

                <div class="difference" id="differenceBox">
                    <div class="time-label">Difference</div>
                    <div class="difference-value" id="difference">--</div>
                    <div id="accuracyLabel">--</div>
                </div>

                <div class="parameter-impact">
                    <div class="impact-label">‚öôÔ∏è Setup Impact Analysis</div>
                    <div class="impact-value" id="setupImpact">--</div>
                </div>
            </div>

            <div class="result-card">
                <h3 style="margin-bottom: 20px; font-size: 1.5em;">üèÅ Segment Analysis: F1 Driver vs Simulator</h3>
                <div id="segmentComparison"></div>
            </div>

            <div class="result-card">
                <h3 style="margin-bottom: 20px; font-size: 1.5em;">üìä Speed Profile</h3>
                <div class="chart-container">
                    <canvas id="speedChart"></canvas>
                </div>
            </div>

            <div class="result-card">
                <h3 style="margin-bottom: 20px; font-size: 1.5em;">üìà Key Telemetry</h3>
                <div class="telemetry-grid" id="telemetryStats">
                    <!-- Stats will be inserted here -->
                </div>
            </div>

            <!-- Lap Animation Preview -->
            <div class="result-card animation-section">
                <h3 style="margin-bottom: 20px; font-size: 1.5em;">üé¨ Lap Animation</h3>
                <div class="animation-container">
                    <div class="animation-title" id="animationTrackName">üìç Live Telemetry Visualization</div>
                    <img id="lapAnimation" 
                         src="../images/lap_animation_silverstone.gif" 
                         alt="F1 Lap Animation" 
                         class="animation-gif"
                         style="display: none;">
                    <p id="animationPlaceholder" style="color: #888; padding: 40px;">
                        üèéÔ∏è Click "Play Animation" to view the simulated lap with live telemetry overlay
                    </p>
                    <div class="animation-controls">
                        <button class="animation-btn" id="playAnimationBtn" onclick="playAnimation()">
                            ‚ñ∂Ô∏è Play Animation
                        </button>
                        <button class="animation-btn secondary" onclick="openFullscreen()">
                            üî≤ Fullscreen
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            F1 Vehicle Dynamics Simulator ¬© 2025 | Powered by Python Physics Engine
        </div>
    </div>

    <script>
        // API Configuration
        // Use deployed Render API by default
        const API_BASE_URL = 'https://f1-simulation-1.onrender.com';
        let useBackend = true;  // Set to false to use mock simulation

        let selectedTrack = null;
        let speedChart = null;
        let lastApiResult = null;  // Store last API result for segment analysis

        const trackData = {
            silverstone: {
                name: "Silverstone Circuit",
                flag: "üá¨üáß",
                length: 5891,
                record: 87.097,
                holder: "Lewis Hamilton (Mercedes) - 2020"
            },
            monaco: {
                name: "Circuit de Monaco",
                flag: "üá≤üá®",
                length: 3337,
                record: 70.166,
                holder: "Lewis Hamilton (Mercedes) - 2019"
            },
            spa: {
                name: "Spa-Francorchamps",
                flag: "üáßüá™",
                length: 7004,
                record: 106.286,
                holder: "Valtteri Bottas (Mercedes) - 2018"
            }
        };

        // Default parameters
        const defaultParams = {
            power: 1000,
            downforce: 100,
            tire: 100,
            mass: 798,
            drag: 100
        };

        let currentParams = { ...defaultParams };

        // Check if backend is available
        async function checkBackend() {
            try {
                const response = await fetch(`${API_BASE_URL}/tracks`, { 
                    method: 'GET',
                    signal: AbortSignal.timeout(2000)
                });
                if (response.ok) {
                    console.log('‚úÖ Backend connected');
                    useBackend = true;
                    return true;
                }
            } catch (e) {
                console.log('‚ö†Ô∏è Backend not available, using mock simulation');
                useBackend = false;
            }
            return false;
        }

        // Call backend API for simulation
        async function callBackendSimulation(track, params) {
            const response = await fetch(`${API_BASE_URL}/simulate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    track: track,
                    vehicle_params: {
                        power: params.power,
                        downforce: params.downforce,
                        tire: params.tire,
                        mass: params.mass,
                        drag: params.drag
                    }
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Simulation failed');
            }
            
            return await response.json();
        }

        // Check backend on page load
        checkBackend();

        // Parameter slider handlers
        document.getElementById('powerSlider').addEventListener('input', function(e) {
            currentParams.power = parseInt(e.target.value);
            document.getElementById('powerValue').textContent = currentParams.power + ' HP';
        });

        document.getElementById('downforceSlider').addEventListener('input', function(e) {
            currentParams.downforce = parseInt(e.target.value);
            document.getElementById('downforceValue').textContent = currentParams.downforce + '%';
        });

        document.getElementById('tireSlider').addEventListener('input', function(e) {
            currentParams.tire = parseInt(e.target.value);
            document.getElementById('tireValue').textContent = currentParams.tire + '%';
        });

        document.getElementById('massSlider').addEventListener('input', function(e) {
            currentParams.mass = parseInt(e.target.value);
            document.getElementById('massValue').textContent = currentParams.mass + ' kg';
        });

        document.getElementById('dragSlider').addEventListener('input', function(e) {
            currentParams.drag = parseInt(e.target.value);
            document.getElementById('dragValue').textContent = currentParams.drag + '%';
        });

        // Preset configurations
        function loadPreset(preset) {
            let params;
            switch(preset) {
                case 'speed':
                    params = { power: 1100, downforce: 60, tire: 100, mass: 750, drag: 70 };
                    break;
                case 'downforce':
                    params = { power: 950, downforce: 150, tire: 120, mass: 798, drag: 120 };
                    break;
                case 'balanced':
                    params = { power: 1000, downforce: 100, tire: 100, mass: 798, drag: 100 };
                    break;
                case 'monaco':
                    params = { power: 950, downforce: 145, tire: 115, mass: 798, drag: 115 };
                    break;
            }
            applyParameters(params);
        }

        function resetParameters() {
            applyParameters(defaultParams);
        }

        function applyParameters(params) {
            currentParams = { ...params };
            document.getElementById('powerSlider').value = params.power;
            document.getElementById('powerValue').textContent = params.power + ' HP';
            document.getElementById('downforceSlider').value = params.downforce;
            document.getElementById('downforceValue').textContent = params.downforce + '%';
            document.getElementById('tireSlider').value = params.tire;
            document.getElementById('tireValue').textContent = params.tire + '%';
            document.getElementById('massSlider').value = params.mass;
            document.getElementById('massValue').textContent = params.mass + ' kg';
            document.getElementById('dragSlider').value = params.drag;
            document.getElementById('dragValue').textContent = params.drag + '%';
        }

        // Track selection
        document.querySelectorAll('.track-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.track-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selectedTrack = this.dataset.track;
                
                const btn = document.getElementById('simulateBtn');
                btn.disabled = false;
                btn.textContent = `üèÅ SIMULATE ${trackData[selectedTrack].name.toUpperCase()}`;
            });
        });

        // Simulate button
        document.getElementById('simulateBtn').addEventListener('click', async function() {
            if (!selectedTrack) return;

            document.getElementById('results').classList.remove('show');
            document.getElementById('loading').style.display = 'block';
            this.disabled = true;

            try {
                await runSimulation(selectedTrack, currentParams);
            } catch (error) {
                console.error('Simulation error:', error);
                alert('Simulation failed. Please try again.');
            } finally {
                document.getElementById('loading').style.display = 'none';
                this.disabled = false;
            }
        });

        function calculatePerformanceMultiplier(params, track) {
            // Calculate how parameters affect lap time
            const powerFactor = (params.power / 1000);
            const downforceFactor = (params.downforce / 100);
            const tireFactor = (params.tire / 100);
            const massFactor = (798 / params.mass);
            const dragFactor = (100 / params.drag);

            // Different tracks benefit from different setups
            let multiplier;
            if (track === 'monaco') {
                // Monaco values downforce and tire grip over power
                multiplier = (powerFactor * 0.2) + (downforceFactor * 0.35) + 
                            (tireFactor * 0.25) + (massFactor * 0.1) + (dragFactor * 0.1);
            } else if (track === 'spa') {
                // Spa values power and low drag
                multiplier = (powerFactor * 0.35) + (downforceFactor * 0.2) + 
                            (tireFactor * 0.15) + (massFactor * 0.15) + (dragFactor * 0.15);
            } else { // silverstone
                // Balanced requirements
                multiplier = (powerFactor * 0.25) + (downforceFactor * 0.25) + 
                            (tireFactor * 0.2) + (massFactor * 0.15) + (dragFactor * 0.15);
            }

            return multiplier;
        }

        function analyzeSetup(params, track) {
            const analysis = [];
            
            if (params.power > 1050) {
                analysis.push("High power setup - excellent for straights");
            } else if (params.power < 900) {
                analysis.push("Low power - struggling on straights");
            }

            if (params.downforce > 120) {
                analysis.push("High downforce - superior cornering");
            } else if (params.downforce < 80) {
                analysis.push("Low downforce - high top speed, reduced grip");
            }

            if (params.tire > 110) {
                analysis.push("Excellent tire grip");
            } else if (params.tire < 90) {
                analysis.push("Reduced grip - careful in corners");
            }

            if (params.mass < 770) {
                analysis.push("Lightweight - nimble but less stable");
            } else if (params.mass > 820) {
                analysis.push("Heavy - stable but slower acceleration");
            }

            if (params.drag < 85) {
                analysis.push("Low drag - maximized top speed");
            } else if (params.drag > 115) {
                analysis.push("High drag - reduced straight-line speed");
            }

            return analysis.length > 0 ? analysis.join(" ‚Ä¢ ") : "Balanced setup across all parameters";
        }

        function generateSegmentComparison(track, params, realTime, simTime) {
            const segments = getTrackSegments(track);
            const container = document.getElementById('segmentComparison');
            
            // Calculate sector times
            const sectors = calculateSectorTimes(segments, realTime, simTime, params);
            
            // Display sector summary
            let html = '<div class="sector-summary">';
            sectors.forEach((sector, idx) => {
                const diff = sector.simTime - sector.f1Time;
                const diffClass = diff < 0 ? 'faster' : 'slower';
                html += `
                    <div class="sector-box">
                        <div class="sector-title">Sector ${idx + 1}</div>
                        <div class="sector-time">${sector.simTime.toFixed(3)}s</div>
                        <div class="sector-diff ${diffClass}">
                            ${diff >= 0 ? '+' : ''}${diff.toFixed(3)}s
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            // Display detailed segment breakdown
            html += '<div class="segment-grid">';
            
            segments.forEach(seg => {
                const diff = seg.simTime - seg.f1Time;
                const diffPercent = (diff / seg.f1Time) * 100;
                const isFaster = diff < 0;
                
                html += `
                    <div class="segment-item ${isFaster ? 'faster' : 'slower'}">
                        <div>
                            <div class="segment-name">${seg.name}</div>
                            <div class="segment-type">${seg.type}</div>
                        </div>
                        <div class="segment-time">
                            <div class="segment-label">F1 Driver</div>
                            <div class="segment-value">${seg.f1Time.toFixed(3)}s</div>
                        </div>
                        <div class="segment-time">
                            <div class="segment-label">Simulator</div>
                            <div class="segment-value">${seg.simTime.toFixed(3)}s</div>
                        </div>
                        <div class="segment-diff ${isFaster ? 'faster' : 'slower'}">
                            ${isFaster ? '‚úì' : '‚úó'} ${diff >= 0 ? '+' : ''}${diff.toFixed(3)}s
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Add analysis
            const analysis = analyzeSegmentPerformance(segments, params, track);
            html += `
                <div class="analysis-box">
                    <div class="analysis-title">üîç Performance Analysis</div>
                    <div class="analysis-text">${analysis}</div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function getTrackSegments(track) {
            const segmentData = {
                silverstone: [
                    { name: 'Abbey', type: 'Fast Corner', length: 250, difficulty: 'medium' },
                    { name: 'Farm Straight', type: 'Straight', length: 400, difficulty: 'easy' },
                    { name: 'Village Complex', type: 'Chicane', length: 230, difficulty: 'hard' },
                    { name: 'Wellington Straight', type: 'Straight', length: 650, difficulty: 'easy' },
                    { name: 'Brooklands-Luffield', type: 'Medium Corners', length: 260, difficulty: 'medium' },
                    { name: 'Maggots-Becketts', type: 'Fast Sequence', length: 440, difficulty: 'hard' },
                    { name: 'Hangar Straight', type: 'Straight', length: 1100, difficulty: 'easy' },
                    { name: 'Stowe-Vale-Club', type: 'Corner Complex', length: 480, difficulty: 'medium' },
                    { name: 'Final Straights', type: 'Straight', length: 901, difficulty: 'easy' }
                ],
                monaco: [
                    { name: 'Sainte Devote', type: 'Slow Corner', length: 100, difficulty: 'hard' },
                    { name: 'Beau Rivage', type: 'Straight', length: 250, difficulty: 'easy' },
                    { name: 'Massenet-Casino', type: 'Slow Corners', length: 200, difficulty: 'hard' },
                    { name: 'Mirabeau-Hairpin', type: 'Hairpin Complex', length: 200, difficulty: 'very_hard' },
                    { name: 'Portier-Tunnel', type: 'Mixed', length: 540, difficulty: 'medium' },
                    { name: 'Nouvelle Chicane', type: 'Chicane', length: 100, difficulty: 'hard' },
                    { name: 'Tabac', type: 'Slow Corner', length: 120, difficulty: 'medium' },
                    { name: 'Swimming Pool', type: 'Chicane Complex', length: 180, difficulty: 'very_hard' },
                    { name: 'Rascasse-Noghes', type: 'Slow Corners', length: 250, difficulty: 'hard' },
                    { name: 'Start Straight', type: 'Straight', length: 597, difficulty: 'easy' }
                ],
                spa: [
                    { name: 'La Source', type: 'Slow Corner', length: 120, difficulty: 'medium' },
                    { name: 'Eau Rouge-Raidillon', type: 'Fast Uphill', length: 320, difficulty: 'very_hard' },
                    { name: 'Kemmel Straight', type: 'Straight', length: 800, difficulty: 'easy' },
                    { name: 'Les Combes', type: 'Chicane', length: 160, difficulty: 'hard' },
                    { name: 'Malmedy-Rivage', type: 'Fast Corners', length: 340, difficulty: 'medium' },
                    { name: 'Bruxelles-Pouhon', type: 'Mixed Section', length: 420, difficulty: 'hard' },
                    { name: 'Campus Straight', type: 'Straight', length: 450, difficulty: 'easy' },
                    { name: 'Stavelot', type: 'Fast Corner', length: 160, difficulty: 'medium' },
                    { name: 'Blanchimont', type: 'Fast Corner', length: 300, difficulty: 'hard' },
                    { name: 'Bus Stop-Finish', type: 'Chicane & Straight', length: 874, difficulty: 'medium' }
                ]
            };
            
            return segmentData[track];
        }

        function calculateSectorTimes(segments, realTime, simTime, params) {
            const trackLength = segments.reduce((sum, s) => sum + s.length, 0);
            
            // First, calculate times for each individual segment
            segments.forEach(seg => {
                const baseTime = (seg.length / trackLength) * realTime;
                
                // Parameters affect different segment types differently
                let multiplier = 1.0;
                
                if (seg.type.includes('Straight')) {
                    // Straights affected by power and drag
                    multiplier *= (1050 - params.power) / 1000 + 0.95;
                    multiplier *= params.drag / 100;
                } else if (seg.type.includes('Corner') || seg.type.includes('Chicane')) {
                    // Corners affected by downforce and tire grip
                    multiplier *= (120 - params.downforce) / 100 + 0.85;
                    multiplier *= (110 - params.tire) / 100 + 0.85;
                }
                
                // Difficulty modifier
                if (seg.difficulty === 'very_hard') {
                    multiplier *= 1.08;
                } else if (seg.difficulty === 'hard') {
                    multiplier *= 1.04;
                } else if (seg.difficulty === 'medium') {
                    multiplier *= 1.02;
                }
                
                seg.f1Time = baseTime;
                seg.simTime = baseTime * multiplier * (1 + (Math.random() - 0.5) * 0.03);
            });
            
            // Now calculate sector summaries
            const segmentsPerSector = Math.ceil(segments.length / 3);
            const sectors = [];
            
            for (let i = 0; i < 3; i++) {
                const sectorSegments = segments.slice(i * segmentsPerSector, (i + 1) * segmentsPerSector);
                
                const f1SectorTime = sectorSegments.reduce((sum, s) => sum + s.f1Time, 0);
                const simSectorTime = sectorSegments.reduce((sum, s) => sum + s.simTime, 0);
                
                sectors.push({
                    f1Time: f1SectorTime,
                    simTime: simSectorTime
                });
            }
            
            return sectors;
        }

        function analyzeSegmentPerformance(segments, params, track) {
            const fasterCount = segments.filter(s => s.simTime < s.f1Time).length;
            const slowerCount = segments.length - fasterCount;
            
            let analysis = `The simulator was faster in ${fasterCount} out of ${segments.length} segments. `;
            
            // Identify problem areas
            const slowestSegments = segments
                .filter(s => s.simTime > s.f1Time)
                .sort((a, b) => (b.simTime - b.f1Time) - (a.simTime - a.f1Time))
                .slice(0, 2);
            
            if (slowestSegments.length > 0) {
                analysis += `Major time losses in: ${slowestSegments.map(s => s.name).join(', ')}. `;
            }
            
            // Analyze by parameter setup
            if (params.power < 950 && segments.some(s => s.type.includes('Straight') && s.simTime > s.f1Time)) {
                analysis += `Low power setting is costing time on straights. `;
            }
            
            if (params.downforce < 85 && segments.some(s => (s.type.includes('Corner') || s.type.includes('Chicane')) && s.simTime > s.f1Time)) {
                analysis += `Insufficient downforce affecting corner performance. `;
            }
            
            if (params.tire < 95 && segments.some(s => s.difficulty === 'very_hard' && s.simTime > s.f1Time)) {
                analysis += `Tire grip limitations in technical sections. `;
            }
            
            // Identify strengths
            const fastestSegments = segments
                .filter(s => s.simTime < s.f1Time)
                .sort((a, b) => (a.simTime - a.f1Time) - (b.simTime - b.f1Time))
                .slice(0, 2);
            
            if (fastestSegments.length > 0) {
                analysis += `Strong performance in: ${fastestSegments.map(s => s.name).join(', ')}.`;
            }
            
            return analysis;
        }

        async function runSimulation(track, params) {
            const trackInfo = trackData[track];
            
            // Try to use backend if available
            if (useBackend) {
                try {
                    const result = await callBackendSimulation(track, params);
                    lastApiResult = result;  // Store for segment analysis
                    
                    // Convert backend response to display format
                    const stats = {
                        maxSpeed: result.max_speed,
                        avgSpeed: result.avg_speed,
                        topGear: 8,
                        drsUsage: calculateDrsUsage(result.telemetry),
                        corneringG: calculateCorneringG(track, params)
                    };
                    
                    displayResultsFromBackend(track, result, stats, params);
                    return;
                } catch (error) {
                    console.error('Backend error:', error);
                    console.log('Falling back to mock simulation');
                    // Fall through to mock simulation
                }
            }
            
            // Mock simulation (fallback)
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const perfMultiplier = calculatePerformanceMultiplier(params, track);
            
            // Base simulation time adjusted by parameters
            let baseTime;
            if (track === 'silverstone') {
                baseTime = 89.5;
            } else if (track === 'monaco') {
                baseTime = 72.8;
            } else {
                baseTime = 109.2;
            }

            // Apply performance multiplier (higher is better, reduces lap time)
            const simTime = baseTime * (2.05 - perfMultiplier) + (Math.random() * 1.5);

            // Calculate stats based on parameters
            const stats = {
                maxSpeed: 0,
                avgSpeed: 0,
                topGear: 8,
                drsUsage: 0,
                corneringG: 0
            };

            if (track === 'silverstone') {
                stats.maxSpeed = 320 + (params.power / 10) - (params.drag / 5) + (Math.random() * 8);
                stats.avgSpeed = 220 + (params.power / 15) + (Math.random() * 5);
                stats.drsUsage = 38 + (100 - params.downforce) / 10 + (Math.random() * 5);
                stats.corneringG = 3.5 + (params.downforce / 50) + (params.tire / 100);
            } else if (track === 'monaco') {
                stats.maxSpeed = 260 + (params.power / 12) - (params.drag / 8) + (Math.random() * 10);
                stats.avgSpeed = 155 + (params.power / 20) + (Math.random() * 5);
                stats.topGear = 7;
                stats.drsUsage = 15 + (100 - params.downforce) / 15 + (Math.random() * 5);
                stats.corneringG = 4.2 + (params.downforce / 40) + (params.tire / 80);
            } else { // spa
                stats.maxSpeed = 340 + (params.power / 8) - (params.drag / 4) + (Math.random() * 7);
                stats.avgSpeed = 230 + (params.power / 12) + (Math.random() * 5);
                stats.drsUsage = 42 + (100 - params.downforce) / 8 + (Math.random() * 5);
                stats.corneringG = 3.8 + (params.downforce / 45) + (params.tire / 90);
            }

            displayResults(track, simTime, stats, params);
        }

        // Helper functions for backend data processing
        function calculateDrsUsage(telemetry) {
            if (!telemetry || !telemetry.drs_active || telemetry.drs_active.length === 0) {
                return 30; // Default fallback
            }
            const activeCount = telemetry.drs_active.filter(d => d === 1).length;
            return (activeCount / telemetry.drs_active.length) * 100;
        }

        function calculateCorneringG(track, params) {
            // Estimate based on downforce and tire grip
            const baseG = track === 'monaco' ? 4.2 : track === 'spa' ? 3.8 : 3.5;
            return baseG + (params.downforce / 50) + (params.tire / 100) - 2;
        }

        // Display results from real backend simulation
        function displayResultsFromBackend(track, result, stats, params) {
            const trackInfo = trackData[track];
            const difference = result.difference;
            const errorPercent = result.error_percent;

            document.getElementById('resultTrackName').textContent = 
                `${trackInfo.flag} ${result.track_name.toUpperCase()} - RESULTS`;

            document.getElementById('realTime').textContent = result.record_time.toFixed(3) + 's';
            document.getElementById('simTime').textContent = result.sim_time.toFixed(3) + 's';
            document.getElementById('recordHolder').textContent = result.record_holder;

            const diffBox = document.getElementById('differenceBox');
            const diffValue = document.getElementById('difference');
            const accuracyLabel = document.getElementById('accuracyLabel');

            diffValue.textContent = `${difference >= 0 ? '+' : ''}${difference.toFixed(3)}s (${errorPercent >= 0 ? '+' : ''}${errorPercent.toFixed(2)}%)`;

            if (Math.abs(errorPercent) < 5) {
                diffBox.className = 'difference excellent';
                accuracyLabel.textContent = '‚úÖ EXCELLENT - Within 5% of Real F1 Time! (Real Physics Engine)';
            } else if (Math.abs(errorPercent) < 10) {
                diffBox.className = 'difference good';
                accuracyLabel.textContent = 'üëç GOOD - Within 10% of Real F1 Time (Real Physics Engine)';
            } else {
                diffBox.className = 'difference needs-work';
                accuracyLabel.textContent = '‚ö†Ô∏è Needs Improvement - Over 10% Error';
            }

            // Setup analysis
            const setupAnalysis = analyzeSetup(params, track);
            document.getElementById('setupImpact').textContent = setupAnalysis;

            // Generate segment comparison from real data
            generateSegmentComparisonFromBackend(result.segments, params, track);

            const telemetryContainer = document.getElementById('telemetryStats');
            telemetryContainer.innerHTML = `
                <div class="telemetry-stat">
                    <div class="stat-label">Max Speed</div>
                    <div class="stat-value">${stats.maxSpeed.toFixed(1)} km/h</div>
                </div>
                <div class="telemetry-stat">
                    <div class="stat-label">Average Speed</div>
                    <div class="stat-value">${stats.avgSpeed.toFixed(1)} km/h</div>
                </div>
                <div class="telemetry-stat">
                    <div class="stat-label">Peak Cornering G-Force</div>
                    <div class="stat-value">${stats.corneringG.toFixed(1)}G</div>
                </div>
                <div class="telemetry-stat">
                    <div class="stat-label">Top Gear Used</div>
                    <div class="stat-value">${stats.topGear}</div>
                </div>
                <div class="telemetry-stat">
                    <div class="stat-label">DRS Usage</div>
                    <div class="stat-value">${stats.drsUsage.toFixed(1)}%</div>
                </div>
                <div class="telemetry-stat">
                    <div class="stat-label">Power Used</div>
                    <div class="stat-value">${params.power} HP</div>
                </div>
            `;

            // Create speed chart from real telemetry data
            createSpeedChartFromBackend(result.telemetry, trackInfo.length);

            // Update animation for selected track
            updateAnimationForTrack();

            document.getElementById('results').classList.add('show');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        // Generate segment comparison from backend data
        function generateSegmentComparisonFromBackend(segments, params, track) {
            const container = document.getElementById('segmentComparison');
            const trackInfo = trackData[track];
            
            // Calculate expected F1 time per segment (proportional to track record)
            const totalLength = segments.reduce((sum, s) => sum + s.length, 0);
            
            segments.forEach(seg => {
                seg.f1Time = (seg.length / totalLength) * trackInfo.record;
            });
            
            // Calculate sectors (3 sectors)
            const segmentsPerSector = Math.ceil(segments.length / 3);
            const sectors = [];
            
            for (let i = 0; i < 3; i++) {
                const sectorSegments = segments.slice(i * segmentsPerSector, (i + 1) * segmentsPerSector);
                const f1SectorTime = sectorSegments.reduce((sum, s) => sum + s.f1Time, 0);
                const simSectorTime = sectorSegments.reduce((sum, s) => sum + s.sim_time, 0);
                
                sectors.push({
                    f1Time: f1SectorTime,
                    simTime: simSectorTime
                });
            }
            
            // Display sector summary
            let html = '<div class="sector-summary">';
            sectors.forEach((sector, idx) => {
                const diff = sector.simTime - sector.f1Time;
                const diffClass = diff < 0 ? 'faster' : 'slower';
                html += `
                    <div class="sector-box">
                        <div class="sector-title">Sector ${idx + 1}</div>
                        <div class="sector-time">${sector.simTime.toFixed(3)}s</div>
                        <div class="sector-diff ${diffClass}">
                            ${diff >= 0 ? '+' : ''}${diff.toFixed(3)}s
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            // Display detailed segment breakdown
            html += '<div class="segment-grid">';
            
            segments.forEach(seg => {
                const diff = seg.sim_time - seg.f1Time;
                const isFaster = diff < 0;
                
                html += `
                    <div class="segment-item ${isFaster ? 'faster' : 'slower'}">
                        <div>
                            <div class="segment-name">${seg.name}</div>
                            <div class="segment-type">${seg.type}</div>
                        </div>
                        <div class="segment-time">
                            <div class="segment-label">F1 Est.</div>
                            <div class="segment-value">${seg.f1Time.toFixed(3)}s</div>
                        </div>
                        <div class="segment-time">
                            <div class="segment-label">Simulator</div>
                            <div class="segment-value">${seg.sim_time.toFixed(3)}s</div>
                        </div>
                        <div class="segment-diff ${isFaster ? 'faster' : 'slower'}">
                            ${isFaster ? '‚úì' : '‚úó'} ${diff >= 0 ? '+' : ''}${diff.toFixed(3)}s
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Add analysis
            const fasterCount = segments.filter(s => s.sim_time < s.f1Time).length;
            let analysis = `The simulator was faster in ${fasterCount} out of ${segments.length} segments. `;
            analysis += `Data powered by real Python physics engine with Pacejka tire model.`;
            
            html += `
                <div class="analysis-box">
                    <div class="analysis-title">üîç Performance Analysis (Real Physics)</div>
                    <div class="analysis-text">${analysis}</div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Create speed chart from real telemetry
        function createSpeedChartFromBackend(telemetry, trackLength) {
            const ctx = document.getElementById('speedChart').getContext('2d');

            if (speedChart) {
                speedChart.destroy();
            }

            speedChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: telemetry.distance.map(d => d.toFixed(0)),
                    datasets: [{
                        label: 'Speed (km/h) - Real Physics',
                        data: telemetry.velocity,
                        borderColor: '#e10600',
                        backgroundColor: 'rgba(225, 6, 0, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff',
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Distance (m)',
                                color: '#fff',
                                font: { size: 12, weight: 'bold' }
                            },
                            ticks: {
                                color: '#fff',
                                maxTicksLimit: 10
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Speed (km/h)',
                                color: '#fff',
                                font: { size: 12, weight: 'bold' }
                            },
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function displayResults(track, simTime, stats, params) {
            const trackInfo = trackData[track];
            const difference = simTime - trackInfo.record;
            const errorPercent = (difference / trackInfo.record) * 100;

            document.getElementById('resultTrackName').textContent = 
                `${trackInfo.flag} ${trackInfo.name.toUpperCase()} - RESULTS`;

            document.getElementById('realTime').textContent = trackInfo.record.toFixed(3) + 's';
            document.getElementById('simTime').textContent = simTime.toFixed(3) + 's';
            document.getElementById('recordHolder').textContent = trackInfo.holder;

            const diffBox = document.getElementById('differenceBox');
            const diffValue = document.getElementById('difference');
            const accuracyLabel = document.getElementById('accuracyLabel');

            diffValue.textContent = `${difference >= 0 ? '+' : ''}${difference.toFixed(3)}s (${errorPercent >= 0 ? '+' : ''}${errorPercent.toFixed(2)}%)`;

            if (Math.abs(errorPercent) < 5) {
                diffBox.className = 'difference excellent';
                accuracyLabel.textContent = '‚úÖ EXCELLENT - Within 5% of Real F1 Time!';
            } else if (Math.abs(errorPercent) < 10) {
                diffBox.className = 'difference good';
                accuracyLabel.textContent = 'üëç GOOD - Within 10% of Real F1 Time';
            } else {
                diffBox.className = 'difference needs-work';
                accuracyLabel.textContent = '‚ö†Ô∏è Needs Improvement - Over 10% Error';
            }

            // Setup analysis
            const setupAnalysis = analyzeSetup(params, track);
            document.getElementById('setupImpact').textContent = setupAnalysis;

            // Generate segment comparison
            generateSegmentComparison(track, params, trackInfo.record, simTime);

            const telemetryContainer = document.getElementById('telemetryStats');
            telemetryContainer.innerHTML = `
                <div class="telemetry-stat">
                    <div class="stat-label">Max Speed</div>
                    <div class="stat-value">${stats.maxSpeed.toFixed(1)} km/h</div>
                </div>
                <div class="telemetry-stat">
                    <div class="stat-label">Average Speed</div>
                    <div class="stat-value">${stats.avgSpeed.toFixed(1)} km/h</div>
                </div>
                <div class="telemetry-stat">
                    <div class="stat-label">Peak Cornering G-Force</div>
                    <div class="stat-value">${stats.corneringG.toFixed(1)}G</div>
                </div>
                <div class="telemetry-stat">
                    <div class="stat-label">Top Gear Used</div>
                    <div class="stat-value">${stats.topGear}</div>
                </div>
                <div class="telemetry-stat">
                    <div class="stat-label">DRS Usage</div>
                    <div class="stat-value">${stats.drsUsage.toFixed(1)}%</div>
                </div>
                <div class="telemetry-stat">
                    <div class="stat-label">Power Used</div>
                    <div class="stat-value">${params.power} HP</div>
                </div>
            `;

            createSpeedChart(track, trackInfo.length, params);

            // Update animation for selected track
            updateAnimationForTrack();

            document.getElementById('results').classList.add('show');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function createSpeedChart(track, trackLength, params) {
            const ctx = document.getElementById('speedChart').getContext('2d');

            const points = 100;
            const distances = [];
            const speeds = [];

            // Speed profile influenced by parameters
            const powerBoost = (params.power - 1000) / 10;
            const dragPenalty = (params.drag - 100) / 5;
            const downforceEffect = (params.downforce - 100) / 10;

            for (let i = 0; i <= points; i++) {
                const dist = (i / points) * trackLength;
                distances.push(dist.toFixed(2));

                let speed;
                if (track === 'silverstone') {
                    speed = 200 + powerBoost - dragPenalty + 140 * Math.sin(i * 0.15) + Math.random() * 10;
                } else if (track === 'monaco') {
                    speed = 120 + powerBoost * 0.5 - dragPenalty + 80 * Math.sin(i * 0.2) + Math.random() * 8;
                } else {
                    speed = 220 + powerBoost - dragPenalty + 130 * Math.sin(i * 0.12) + Math.random() * 12;
                }
                speeds.push(Math.max(80, Math.min(370, speed)));
            }

            if (speedChart) {
                speedChart.destroy();
            }

            speedChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: distances,
                    datasets: [{
                        label: 'Speed (km/h)',
                        data: speeds,
                        borderColor: '#e10600',
                        backgroundColor: 'rgba(225, 6, 0, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff',
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Distance (m)',
                                color: '#fff',
                                font: { size: 12, weight: 'bold' }
                            },
                            ticks: {
                                color: '#fff',
                                maxTicksLimit: 10
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Speed (km/h)',
                                color: '#fff',
                                font: { size: 12, weight: 'bold' }
                            },
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Animation controls
        function getAnimationPath() {
            // Return the correct animation path based on selected track
            if (selectedTrack) {
                return `../images/lap_animation_${selectedTrack}.gif`;
            }
            return '../images/lap_animation_silverstone.gif';
        }

        function updateAnimationForTrack() {
            // Update animation title and reset state when track changes
            const titleEl = document.getElementById('animationTrackName');
            const img = document.getElementById('lapAnimation');
            const placeholder = document.getElementById('animationPlaceholder');
            const btn = document.getElementById('playAnimationBtn');
            
            if (selectedTrack && trackData[selectedTrack]) {
                const trackInfo = trackData[selectedTrack];
                titleEl.textContent = `üìç ${trackInfo.flag} ${trackInfo.name} - Live Telemetry`;
            }
            
            // Reset animation state
            img.style.display = 'none';
            placeholder.style.display = 'block';
            btn.innerHTML = '‚ñ∂Ô∏è Play Animation';
        }

        function playAnimation() {
            const img = document.getElementById('lapAnimation');
            const placeholder = document.getElementById('animationPlaceholder');
            const btn = document.getElementById('playAnimationBtn');
            
            if (img.style.display === 'none') {
                // Show and reload GIF to restart animation
                placeholder.style.display = 'none';
                img.style.display = 'block';
                // Force reload with track-specific animation
                img.src = getAnimationPath() + '?' + new Date().getTime();
                btn.innerHTML = '‚è∏Ô∏è Hide Animation';
            } else {
                // Hide animation
                img.style.display = 'none';
                placeholder.style.display = 'block';
                btn.innerHTML = '‚ñ∂Ô∏è Play Animation';
            }
        }

        function openFullscreen() {
            const img = document.getElementById('lapAnimation');
            img.style.display = 'block';
            document.getElementById('animationPlaceholder').style.display = 'none';
            
            // Force reload with track-specific animation
            img.src = getAnimationPath() + '?' + new Date().getTime();
            
            if (img.requestFullscreen) {
                img.requestFullscreen();
            } else if (img.webkitRequestFullscreen) {
                img.webkitRequestFullscreen();
            } else if (img.msRequestFullscreen) {
                img.msRequestFullscreen();
            }
        }
    </script>
</body>
</html>
